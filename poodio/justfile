build TARGET:
    @printf '{}' > 'package.json'
    npx napi build --cargo-flags=--locked --no-dts-header --release \
        --target '{{ TARGET }}' 'dist/npm/bind/'
    @rm -f 'package.json'

    @mkdir -p 'dist/bin/'
    cp '../target/{{ TARGET }}/release/poodio{{ BIN_EXT }}' 'dist/bin/'
    cp 'dist/npm/bind/index.d.ts' 'dist/npm/wrap/'

    @printf '{{ NPM_DIST_PURE_MAIN_DATA }}' > 'dist/npm/wrap/index.js'
    chmod +x 'dist/npm/wrap/index.js'

    npm i

    uv run maturin build --target '{{ TARGET }}' --out 'dist/uv/'

test SUBJECTS='':
    #! /usr/bin/env bash
    for s in {{ SUBJECTS }}; do npx @poodio/test-$s; done

BIN_EXT := if os() == 'windows' { '.exe' } else { '' }
NPM_DIST_PURE_MAIN_DATA := '''
#! /usr/bin/env node
require("tell-libc");
const { name } = require("./package.json");
const { argv, arch: cpu, platform: os, libc } = process;
const m = require(`@${name}/${name}-${cpu}-${os}-${libc || "unknown"}`);
module.exports = m;
require.main === module && m.main(argv.slice(1));
'''
